from pathlib import Path
from typing import TYPE_CHECKING
import pandas as pd
import numpy as np
import utils.zone_interval as zone_interval
import parameters.zone as param



from events.model_system_event_listener import ModelSystemEventListener

if TYPE_CHECKING:
    from modelsystem import ModelSystem
    from assignment.emme_assignment import AssignmentModel
    from datahandling.zonedata import ZoneData


class GarbageGenerationResult(ModelSystemEventListener):
    """
    A class to print calculated garbage generation to results directory.
    """
    result_path: Path
    """ The path to the result file. """
    
    def __init__(self):
        super().__init__()
    
    def on_model_system_initialized(self,
                                    model_system: 'ModelSystem',
                                    zone_data_path: str, 
                                    base_zone_data_path: str, 
                                    base_matrices_path: str,
                                    results_path: str, 
                                    assignment_model: 'AssignmentModel', 
                                    name: str) -> None:
        # Get result path when model system is initialized
        self.result_path = Path(results_path) / name / 'garbage_generation_municipalities.csv'

    def on_garbage_trips_generated(self, garbage_generated):
        # Use ArrayAggregator to aggregate by municipality
        from utils.zone_interval import ArrayAggregator

        # Create aggregator for municipalities
        aggregator = ArrayAggregator(garbage_generated.index)
        aggregator.keys = list(param.municipalities.keys())
        aggregator._intervals = param.municipalities

        # Aggregate each column
        agg_dict = {}
        for col in garbage_generated.columns:
            agg_dict[col] = aggregator.aggregate(garbage_generated[col])

        agg_df = pd.DataFrame(agg_dict)
        agg_df.index.name = "municipality"

        # Write docstring as comments at the top of the CSV
        docstring = [
            "# Garbage genaration per municipality per year. Logistics doesn't generate garbage.",
            "#",
            "#   population_garbage: Garbage generated by population (kg/year)",
            "#   services_garbage: Garbage generated by services (kg/year)",
            "#   shops_garbage: Garbage generated by shops (kg/year)",
            "#   industry_garbage: Garbage generated by industry (kg/year)",
            "#   total_garbage: Total garbage generated (kg/year)",
            ""
        ]
        with open(self.result_path, "w", encoding="utf-8") as f:
            for line in docstring:
                f.write(line + "\n")
            agg_df.to_csv(f, lineterminator='\n')